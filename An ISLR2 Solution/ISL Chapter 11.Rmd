---
title: "Chapter 11 Survival Analysis"
output:
  pdf_document: default
---

```{r}
library(ISLR2)
library(survival)
library(dplyr)
```

# Exercise 1

Independent: a, d, e, g, i

Not independent: b, c, f, h

# Exercise 2

|                 | 1       | 2       | 3       | 4       |
|-----------------|---------|---------|---------|---------|
| c               | unknown | 2       | 1.5     | unknown |
| k               | 1.2     | unknown | unknown | 0.2     |
| y               | 1.2     | 2       | 1.5     | 0.2     |
| $$              
    \delta        
    $$            | 1       | 0       | 0       | 1       |

# Exercise 3

| t   | $$                               
                            r_{j}        
                            $$           | $$                                                                                  
                                                                                                                  d_{j}        
                                                                                                                  $$           | $$                                                                                                                                                                      
                                                                                                                                                                                                                                                                                            q_{j}        
                                                                                                                                                                                                                                                                                            $$           |
|------------------|------------------|------------------|------------------|
| 0   | 4                                | 0                                                                                   | 0                                                                                                                                                                       |
| 0.2 | 4                                | 1                                                                                   | 0                                                                                                                                                                       |
| 1.2 | 3                                | 1                                                                                   | 1                                                                                                                                                                       |
| 2   | 1                                | 0                                                                                   | 1                                                                                                                                                                       |

# Exercise 4

## a

S(50) = 0.6

## b

S(t) = 0.8 if t \< 37.2

S(t) = 0.6 if t \< 57.3

S(t) = 0.4 if t \>= 57.3

# Exercise 5

```{r}
data = data.frame(time = c(0, 31, 77, 100), status = c(1, 1, 1, 0))
data_curve = survfit(Surv(time, status) ~ 1, data = data)
plot(data_curve)
```

# Exercise 6

## a

|     |                                                |                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|---------------|---------------|---------------|---------------|---------------|
| t   | $$                                             
                                   \delta_{j}          
                                   $$                  | $$                                                                                                                                                  
                                                                                                                                                                                              r_{j}          
                                                                                                                                                                                              $$             | $$                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            d_{j}          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $$             | $$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   q_{j}          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   $$             |
| 0   | 1                                              | 4                                                                                                                                                   | 0                                                                                                                                                                                                                                                                                                                                                           | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 150 | 0                                              | 4                                                                                                                                                   | 1                                                                                                                                                                                                                                                                                                                                                           | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 300 | 1                                              | 3                                                                                                                                                   | 1                                                                                                                                                                                                                                                                                                                                                           | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 370 | 0                                              | 1                                                                                                                                                   | 0                                                                                                                                                                                                                                                                                                                                                           | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

## b

```{r}
data = data.frame(time = c(150, 250, 300, 370), status = c(1, 0, 1, 0))
data_curve = survfit(Surv(time, status) ~ 1, data = data)
plot(data_curve)
summary(data_curve)
```

## c

S(t) = 0.15

S(t) = 0.375

## d

S(t) = 0.75 if t \< 300

S(t) = 0.375 if t $$ \ge $$ 300

# Exercise 7

## a

If we think q (the number of deaths) as "successes" (although we don't mean it literally), q follows Hypergeometric distribution

$$
q_{1} \sim Hyper(r_{k}, q_{k}, r_{1k}) 
$$

$$
P( q_{1}= q'_{1k}) =\dfrac{\begin{pmatrix} q_{k} \\ q'_{1k} \end{pmatrix}\begin{pmatrix} r_{k} & - & q_{k} \\ r_{1k} & - & q'_{1k} \end{pmatrix}}{\begin{pmatrix} r_{k} \\ r_{1k} \end{pmatrix}}
$$

where

$$ r_{k} $$ is the population size,

$$ q_{k} $$ is the number of successes,

$$ r_{1k} $$ is the number of draws,

$$ q'_{1k} $$ is the number of observed succeses

## b

$$
Mean(q_{1k}) = r_{1k}.\dfrac{q_k}{rk}
$$

$$
Variance(q_{1k}) = r_{1k}.\dfrac{q_k}{rk}.\dfrac{r_{k} - q_{k}}{r_{k}}.\dfrac{r_{k} - r_{1k}}{r_{k} - 1}
$$

# Exercise 8

## a

$$
= 
\lim _{\Delta t\rightarrow 0}=\dfrac{F\left( t+\Delta t\right) -F\left( t\right) }{\Delta t}
$$

$$
=
\lim _{\Delta t\rightarrow 0}=\dfrac{1-S\left( t+\Delta t\right) -F\left( t\right) }{\Delta t}
$$

$$
=
\lim _{\Delta t\rightarrow 0}=\dfrac{1-S\left( t+\Delta t\right) -P\left( T < t\right) }{\Delta t}
$$

$$
=
\lim _{\Delta t\rightarrow 0}=\dfrac{1-P\left( T >  t+\Delta t\right) -P\left( T < t\right) }{\Delta t}
$$

$$
=
\lim _{\Delta t\rightarrow 0}=\dfrac{P\left( T \le t+\Delta t\right) -P\left( T < t\right) }{\Delta t}
$$

$$
=
\lim _{\Delta t\rightarrow 0}=\dfrac{P \left( t < T \le t + \Delta t \right)}{\Delta t}
$$

$$
=f(t)
$$

## b

$$
\dfrac{dF(t)}{dt} = f(t)
$$

$$
\Leftrightarrow -\dfrac{dS(t)}{dt} = f(t)
$$

$$
\Leftrightarrow -\dfrac{dS(t)}{dt} \dfrac{1}{S(t)} = \dfrac{f(t)}{S(t)}
$$

$$
\Leftrightarrow
-\dfrac{dlog(S(t))}{dt} = h(t)
$$

$$
\Leftrightarrow -log(S(t)) = \int ^{t}_{0}h\left( u\right) du
$$

$$
\Leftrightarrow S(t) = \exp \left ( -\int^{t}_{0} h(u)du \right)
$$

# Exercise 9

## a

$$
T \sim Exp(\lambda)
$$

$$
\Rightarrow P(T = t) = \lambda e^{-\lambda t}
$$

$$
\Rightarrow P(T > t) = e^{-\lambda t}
$$

$$
\Rightarrow S(t) = e^{-\lambda t}
$$

## b

$$
 X \sim Exp(\lambda)
$$

$$
\Rightarrow \hat{\lambda}_{MLE} = \dfrac{1} {\overline{x}} = \dfrac{n}{\sum^{}_{i}x_{i}}
$$

We have $$ T \sim Exp(\lambda) ~ and ~ t_{1},~ t_{2}, ...,~ t_{n} $$ are independent samples from T (t could be the true survival time or the censoring time and we also assume that censoring mechanism is independent). So,

$$
\lambda _{MLE}=\dfrac{n}{\sum _{i}t_{i}}=\dfrac{\sum ^{n}_{i=1}\delta _{i}}{\sum ^{n}_{i=1}y_{i}}
$$

And,

$$
Mean(T) = =\dfrac{\sum ^{n}_{i=1}y_{i}}{\sum ^{n}_{i=1}\delta _{i}}
$$

# Exercise 10

```{r}
library(ISLR2)
library(survival)
library(dplyr)
```

```{r}
head(BrainCancer)
```

## a

```{r}
attach(BrainCancer)
km_95_curve = survfit(Surv(time, status) ~ 1, conf.int = 0.95)
plot(km_95_curve, xlab = 'Months', ylab = 'Estimates Probability of Survival')
summary(km_95_curve)
```

```{r}
km_68_curve = survfit(Surv(time, status) ~ 1, conf.int = 0.68)
plot(km_68_curve, xlab = 'Months', ylab = 'Estimates Probability of Survival')
summary(km_68_curve)
```

## b

```{r}
# an example
braincancer_by_time = data.frame(time = sort(BrainCancer$time))
set.seed(42)

bootstrap_indices = sample(nrow(BrainCancer), size = 88, replace = T)
bootstrap_sample = BrainCancer[bootstrap_indices, ]
bootstrap_curve = survfit(Surv(time, status) ~ 1, data = bootstrap_sample)

#plot(bootstrap_curve)
#summary(bootstrap_curve)

bootstrap_df_sample = data.frame(time = bootstrap_curve$time,
                                 survive = bootstrap_curve$surv)
braincancer_by_time
arrange(bootstrap_sample, time)
merge(x = braincancer_by_time, y = bootstrap_df_sample,
      by = 'time', all.x = T)
```

```{r}
set.seed(42)

B = 200
results = braincancer_by_time

for (i in 1:B){
  
  #print(i)
  bootstrap_index = sample(nrow(BrainCancer), size = 88, replace = T)
  a_bootstrap_sample = BrainCancer[bootstrap_index, ]
  a_bootstrap_km_curve = survfit(Surv(time, status) ~ 1, 
                                 data = a_bootstrap_sample,
                                 conf.int = 0.68)
  a_bootstrap_df = data.frame(time = a_bootstrap_km_curve$time,
                              survive = a_bootstrap_km_curve$surv)
  results = merge(x = results, y = a_bootstrap_df,
                  by = 'time', all.x = T)

}

# View(results)
```

```{r}

for (i in 1:nrow(BrainCancer)){
  
  a_row = na.omit(as.numeric(results[i, 2:201]))
  mean_prob = mean(a_row)
  std = sd(a_row)
  upper_bound = mean_prob + 1 * std
  lower_bound = mean_prob - 1 * std
  results[i, 'mean'] = mean_prob
  results[i, 'upper_bound'] = upper_bound
  results[i, 'lower_bound'] = lower_bound
  
}

View(results)
```

```{r}
plot(km_68_curve, xlab = 'Months', ylab = 'Estimates Probability of Survival')
lines(x = results$time, y = results$mean, col = 'red', lty = 9)
lines(x = results$time, y = results$upper_bound, col = 'blue', lty = 8)
lines(x = results$time, y = results$lower_bound, col = 'purple', lty = 7)
```

## c

```{r}
cox_model = coxph(Surv(time, status) ~ ., data = BrainCancer)
cox_model
```

There are two statistically significant predictors: HG glioma and ki.

Patients diagnosed with HG glioma have a probability of event occurring (die) 8.6 times higher than patients who are not diagnosed with HG glioma. (lower probability of survival)

Each additional "ki" leads to an 0.95-fold increase in the risk of being died.

## d

```{r}
braincancer = BrainCancer
braincancer$ki_group = (cut(BrainCancer$ki, breaks = c(0, 60, 70, 80, 90, 100),
                            labels = c('60', '70', '80', '90', '100')))
table(BrainCancer$ki)
table(braincancer$ki_group)
```

```{r}
ki_model = survfit(Surv(time, status) ~ ki_group, data = braincancer)
plot(ki_model, xlab = 'Months', ylab = 'Probability of Survival',
     col = c(2, 3, 4, 5, 6))
legend('bottomleft', legend = levels(braincancer$ki_group),
       col = c(2, 3, 4, 5, 6))
```

# Exercise 11

## a

```{r}
Observation = c(26.5, 37.2, 57.3, 90.8, 20.2, 89.8)
Censoring_Indicator = c(1, 1, 1, 0, 0, 0) 
Covariate = c(0.1, 11, -0.3, 2.8, 1.8, 0.4)

data = data.frame(observation = Observation,
                  censoring_indicator = Censoring_Indicator,
                  covariate = Covariate)

data
```

```{r}
data$covariate_group = cut(data$covariate, breaks = c(-Inf, 2, Inf), 
                           labels = c('X < 2', 'X > 2'))
covariate_curve = survfit(Surv(observation, censoring_indicator) ~ covariate_group,
                          data = data)
plot(covariate_curve, xlab = 'Observation', 
     ylab = 'Estimated Probability of Survival',
     col = c(2, 3))
legend('topright', legend = c('X < 2', 'X > 2'), col = c(2, 3))
```

## b

```{r}
cox_model = coxph(Surv(observation, censoring_indicator) ~ covariate_group,
                          data = data)
cox_model
```

Objects in group number 2 (where X is greater than or equal 2) have a risk of event occurring 0.7117-fold higher than Objects in group number 1.

Since p-value is greater than 0.05 (approximately 0.78), the data provides convincing evidence that the true coefficient is non-zero. (There is a difference between 2 groups).

## c

```{r}
log_rank_test = survdiff(Surv(observation, censoring_indicator) ~ covariate_group,
                          data = data)
log_rank_test
```

The p-value results from Cox model and log-rank test are identical. The result above was rounded.
